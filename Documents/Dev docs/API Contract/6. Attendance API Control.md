
## 📘 API Contract — `Attendance Module`

> Version: `v1`  
> Base Path: `/api/v1/attendance`  
> Auth Required: ✅ Yes (JWT)  
> Roles Permitted: `SuperAdmin`, `Admin`, `Teacher`, `Student`, `Parent`

---

### 🔐 Access Control Rules

|Action|Role|Scope|
|---|---|---|
|Mark attendance|Teacher|Own classes and sections only|
|View attendance summary|Admin, SuperAdmin|School-wide or filtered by class, date|
|View personal attendance|Student|Self|
|View child attendance|Parent|Only linked children|
|Submit leave request|Student|Self|
|Approve/Reject leave request|Admin|School-wide|
|Flag absence for review|Teacher|Students in assigned sections|

---

### 📚 Endpoint Catalog

|Method|Path|Description|Auth & Roles|
|---|---|---|---|
|POST|`/records/mark`|Mark attendance for a class/section|Teacher|
|GET|`/records/:date/class/:class_id`|Get attendance for a class on a given day|Teacher/Admin|
|GET|`/records/student/:student_id`|Get full attendance history of a student|Admin/Teacher/Student/Parent|
|GET|`/records/student/:student_id/summary`|Get attendance summary for a student|Admin/Teacher/Parent/Student|
|POST|`/leave`|Submit leave request|Student|
|GET|`/leave/:student_id`|View leave requests of a student|Student/Parent/Admin|
|PUT|`/leave/:id/approve`|Approve leave request|Admin|
|PUT|`/leave/:id/reject`|Reject leave request|Admin|
|POST|`/absentee-flags/:record_id/flag`|Flag absence for review|Teacher|
|GET|`/absentee-flags`|Get all absentee flags for review|Admin|

---

### 🧾 TypeScript Schemas

#### 🛠️ `MarkAttendanceRequest`

```ts
interface MarkAttendanceRequest {
  class_id: string;
  section_id: string;
  date: string; // ISO date
  entries: {
    student_id: string;
    status: 'present' | 'absent' | 'late';
    remarks?: string;
  }[];
}
```

#### ✅ `AttendanceRecordResponse`

```ts
interface AttendanceRecordResponse {
  id: string;
  class_id: string;
  section_id: string;
  date: string;
  student_id: string;
  status: 'present' | 'absent' | 'late';
  remarks?: string;
  marked_by: string; // user_id of teacher/admin
  created_at: string;
}
```

#### 🛠️ `LeaveRequest`

```ts
interface LeaveRequest {
  student_id: string;
  from_date: string; // ISO date
  to_date: string;   // ISO date
  reason: string;
  leave_type: 'medical' | 'personal' | 'other';
}
```

#### ✅ `LeaveResponse`

```ts
interface LeaveResponse {
  id: string;
  student_id: string;
  from_date: string;
  to_date: string;
  reason: string;
  leave_type: string;
  status: 'pending' | 'approved' | 'rejected';
  reviewed_by?: string;
  reviewed_at?: string;
  created_at: string;
}
```

#### 🛠️ `FlagAbsenceRequest`

```ts
interface FlagAbsenceRequest {
  reason: string;
  flagged_by: string; // teacher user_id
}
```

#### ✅ `AbsenteeFlagResponse`

```ts
interface AbsenteeFlagResponse {
  id: string;
  attendance_record_id: string;
  student_id: string;
  reason: string;
  flagged_by: string;
  status: 'under_review' | 'justified' | 'dismissed';
  reviewed_by?: string;
  reviewed_at?: string;
  created_at: string;
}
```

---

### ⚠️ Standard Error Object

```ts
interface ErrorResponse {
  statusCode: number;
  error: string;
  message: string;
  code?: string; // e.g. ATTENDANCE_ALREADY_MARKED, LEAVE_OVERLAP, STUDENT_NOT_FOUND
}
```

---

### 🔐 Security Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
X-Request-ID: <uuid>
```

---

### 🔗 Notes on Relations

- `attendance_records.student_id` → `students.id`
    
- `leave_requests.student_id` → `students.id`
    
- `absentee_flags.attendance_record_id` → `attendance_records.id`
    
- Teachers can only mark/view attendance for students in their assigned `teacher_subjects` or `class_sections`
    
- Leave requests are reviewed and updated by Admins only
    

---

### ✅ Role Constraints + Guards

#### Teacher

- Can mark attendance only once per date per class/section
    
- Cannot update once marked
    
- Can flag absences only for students they marked
    

#### Student

- Can view only their own records
    
- Can apply for leave overlapping future dates
    

#### Parent

- View only linked student’s attendance or leave
    

#### Admin / SuperAdmin

- Full access to all data
    
- Responsible for reviewing/approving leave and flagged absences
    

---

### 📋 Sample Flows

#### 1. Mark Attendance

- **Request**: `POST /records/mark`
    
    - Body: `MarkAttendanceRequest`
        
- **Response**: `200 OK` with list of `AttendanceRecordResponse`
    

#### 2. View Student Summary

- **Request**: `GET /records/student/:student_id/summary`
    
- **Response**: Object with counts of `present`, `absent`, `late`, `leave_approved`
    

#### 3. Submit Leave

- **Request**: `POST /leave`
    
    - Body: `LeaveRequest`
        
- **Response**: `200 OK` → `LeaveResponse`
    

#### 4. Approve Leave

- **Request**: `PUT /leave/:id/approve`
    
- **Response**: `200 OK` with updated `LeaveResponse`
    

#### 5. Flag Absentee

- **Request**: `POST /absentee-flags/:record_id/flag`
    
    - Body: `FlagAbsenceRequest`
        
- **Response**: `201 Created` → `AbsenteeFlagResponse`
    

---
