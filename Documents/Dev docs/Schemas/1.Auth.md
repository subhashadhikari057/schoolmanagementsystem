
### 🗂️ Tables Overview

|Table Name|Purpose|
|---|---|
|`users`|Core identity record for any person in the system|
|`roles`|System-wide named access roles (e.g., Admin, Teacher)|
|`permissions`|Fine-grained abilities (e.g., `can_create_exam`)|
|`user_roles`|Many-to-many mapping between users and roles|
|`role_permissions`|Role ⇄ permission assignment (optional)|
|`user_sessions`|Active login tokens, fingerprinting, expiration|

---

## 📄 Schema Definitions (PostgreSQL DDL)

---

### 🔐 `users`

```sql
CREATE TABLE auth.users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Required + unique email (regex is case-insensitive)
    email VARCHAR(255) NOT NULL UNIQUE
          CHECK (email ~* '^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$'),

    phone VARCHAR(20) UNIQUE,
    password_hash TEXT NOT NULL,
    full_name VARCHAR(150) NOT NULL,

    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMPTZ,
    last_password_change TIMESTAMPTZ,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

-- Indexes
CREATE UNIQUE INDEX idx_users_email  ON auth.users(email);
CREATE UNIQUE INDEX idx_users_phone  ON auth.users(phone);
CREATE INDEX       idx_users_created_by ON auth.users(created_by);
CREATE INDEX       idx_users_updated_by ON auth.users(updated_by);
CREATE INDEX       idx_users_deleted_by ON auth.users(deleted_by);
```

---

### 🎭 `roles`

```sql
CREATE TABLE auth.roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    is_system_role BOOLEAN DEFAULT FALSE,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

CREATE INDEX idx_roles_name        ON auth.roles(name);
CREATE INDEX idx_roles_created_by  ON auth.roles(created_by);
CREATE INDEX idx_roles_updated_by  ON auth.roles(updated_by);
CREATE INDEX idx_roles_deleted_by  ON auth.roles(deleted_by);
```

---

### 🔑 `permissions`

```sql
CREATE TABLE auth.permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    module VARCHAR(50),

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

CREATE INDEX idx_permissions_code       ON auth.permissions(code);
CREATE INDEX idx_permissions_module     ON auth.permissions(module);
CREATE INDEX idx_permissions_created_by ON auth.permissions(created_by);
CREATE INDEX idx_permissions_updated_by ON auth.permissions(updated_by);
CREATE INDEX idx_permissions_deleted_by ON auth.permissions(deleted_by);
```

---

### 🧩 `user_roles`

```sql
CREATE TABLE auth.user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    role_id UUID NOT NULL REFERENCES auth.roles(id) ON DELETE CASCADE,
    assigned_at TIMESTAMPTZ DEFAULT now(),

    UNIQUE (user_id, role_id)
);

CREATE INDEX idx_user_roles_user_id ON auth.user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON auth.user_roles(role_id);
```

---

### 🧷 `role_permissions`

```sql
CREATE TABLE auth.role_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    role_id UUID NOT NULL REFERENCES auth.roles(id) ON DELETE CASCADE,
    permission_id UUID NOT NULL REFERENCES auth.permissions(id) ON DELETE CASCADE,
    granted_at TIMESTAMPTZ DEFAULT now(),

    UNIQUE (role_id, permission_id)
);

CREATE INDEX idx_role_permissions_role_id   ON auth.role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON auth.role_permissions(permission_id);
```

---

### 📲 `user_sessions`

```sql
CREATE TABLE auth.user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    token_hash TEXT NOT NULL,
    user_agent TEXT,
    ip_address INET,
    device_fingerprint TEXT,
    login_at TIMESTAMPTZ DEFAULT now(),
    expires_at TIMESTAMPTZ,
    revoked_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ DEFAULT now(),

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_user_sessions_user_id     ON auth.user_sessions(user_id);
CREATE INDEX idx_user_sessions_expires_at  ON auth.user_sessions(expires_at);
CREATE INDEX idx_user_sessions_created_by  ON auth.user_sessions(created_by);
CREATE INDEX idx_user_sessions_updated_by  ON auth.user_sessions(updated_by);
CREATE INDEX idx_user_sessions_deleted_by  ON auth.user_sessions(deleted_by);
```

---

## 🚨 Duplicate Email / Phone Handling (Application Layer)

> **Why**: Even with DB constraints, the API **must** translate `SQLSTATE 23505` conflicts into a user-friendly response.

```ts
try {
  await createUser(payload);     // INSERT … INTO auth.users …
} catch (err: any) {
  if (err.code === '23505') {    // unique_violation
    const field = err.constraint.includes('email') ? 'email' : 'phone';
    throw new ApiError(409, `${field.charAt(0).toUpperCase() + field.slice(1)} already in use`, `DUPLICATE_${field.toUpperCase()}`);
  }
  throw err;                     // re-throw other errors
}
```

Returned JSON example:

```json
{
  "statusCode": 409,
  "error": "Conflict",
  "message": "Email already in use",
  "code": "DUPLICATE_EMAIL"
}
```

---

## 📌 Indexing Best Practices

```sql
-- Fast login look-ups
CREATE UNIQUE INDEX idx_users_email ON auth.users(email);
CREATE UNIQUE INDEX idx_users_phone ON auth.users(phone);

-- Session expiry sweep
CREATE INDEX idx_user_sessions_expires_at ON auth.user_sessions(expires_at);

-- Permissions filtering
CREATE INDEX idx_permissions_module ON auth.permissions(module);
```

All other `created_by / updated_by / deleted_by` indexes have been included inline with their tables for audit-trail performance.

---