---

## 4.1 ⚙️ API Design Principles & Versioning

### 🔧 Design Philosophy

|Principle|Description|
|---|---|
|**Modular Contracts**|API endpoints are grouped by domain modules (student, exam, finance, etc.)|
|**Versioned Paths**|URL paths are versioned (e.g., `/api/v1/`) to support backward compatibility|
|**Typed Payloads**|All requests and responses strictly follow JSON Schema / TypeScript interface definitions|
|**Stateless APIs**|All endpoints follow RESTful statelessness; auth is passed via headers|
|**Consistent Naming**|Paths use plural, snake_case naming: `/students`, `/fee_payments`|
|**Security by Default**|Auth required for all endpoints unless explicitly marked as public|
|**Extensible Metadata**|Supports optional `metadata` fields (JSONB) for future extensibility|

---

### 📦 Base URL & Versioning

| Item           | Format                |
| -------------- | --------------------- |
| **Base URL**   | `/api/v1/`            |
| **Versioning** | URI-based (`/v1/...`) |
| **Header**     | `X-API-Version: v1`   |

Future versions (`v2`, etc.) will retain old versions for at least 12 months.

---

## 4.2 📚 Modular Endpoint Catalog

Each module is independently versioned and described below. All endpoints default to `application/json`.

Each endpoint definition includes:

- **Method**
- **Path**
- **Authentication**
- **Request Body**
- **Response**
- **Error Scenarios**

### 🛡️ **Standardized Error Handling**

All API endpoints use a **standardized error response format** implemented via:

- **Global Exception Filter**: Catches all exceptions and formats responses consistently
- **Trace ID Middleware**: Adds unique UUID to each request for debugging
- **Standard Error Envelope**: Uses centralized schemas from `@sms/shared-types`

**Error Response Format:**

```json
{
  "success": false,
  "statusCode": 400,
  "error": "Bad Request",
  "message": "Validation failed",
  "code": "VALIDATION_ERROR",
  "traceId": "123e4567-e89b-12d3-a456-426614174000",
  "timestamp": "2025-01-31T10:30:00.000Z",
  "severity": "medium",
  "details": {
    "validation": [
      {
        "field": "email",
        "message": "Invalid email format",
        "code": "INVALID_FORMAT"
      }
    ]
  },
  "context": {
    "endpoint": "/api/v1/students",
    "method": "POST",
    "requestId": "123e4567-e89b-12d3-a456-426614174000"
  }
}
```

**Error Types Handled:**

- ✅ **HTTP Exceptions** (400, 401, 403, 404, etc.)
- ✅ **Validation Errors** (Zod schema failures)
- ✅ **Database Errors** (Prisma/PostgreSQL constraints)
- ✅ **Business Logic Errors** (Custom application rules)
- ✅ **Rate Limiting** (Too many requests)
- ✅ **Unknown Errors** (Fallback handling)

**Response Headers:**

- `X-Trace-ID`: Unique request identifier for debugging
- `Content-Type: application/json`: Always JSON responses

---

### ✅ **Module: Auth**

| Method | Path                  | Auth   | Description                |
| ------ | --------------------- | ------ | -------------------------- |
| POST   | `/auth/login`         | ❌ No  | Login via email/password   |
| POST   | `/auth/logout`        | ✅ Yes | Invalidate current session |
| GET    | `/auth/me`            | ✅ Yes | Get current user profile   |
| POST   | `/auth/refresh-token` | ✅ Yes | Refresh JWT token          |

---

### 🧑‍🎓 **Module: Student**

| Method | Path                    | Auth      | Description         |
| ------ | ----------------------- | --------- | ------------------- |
| GET    | `/students`             | Admin, SA | List students       |
| POST   | `/students`             | Admin     | Create new student  |
| GET    | `/students/:id`         | Admin, SA | Get student by ID   |
| PUT    | `/students/:id`         | Admin     | Update student      |
| DELETE | `/students/:id`         | Admin     | Soft-delete student |
| GET    | `/students/:id/profile` | Student   | View own profile    |

---

### 🧑‍🏫 **Module: Teacher**

| Method | Path                     | Auth      | Description            |
| ------ | ------------------------ | --------- | ---------------------- |
| GET    | `/teachers`              | Admin, SA | List teachers          |
| POST   | `/teachers`              | Admin     | Add teacher            |
| GET    | `/teachers/:id`          | Admin, SA | Get teacher            |
| PUT    | `/teachers/:id`          | Admin     | Update teacher info    |
| GET    | `/teachers/:id/subjects` | Teacher   | View assigned subjects |

---

### 📝 **Module: Assignments**

| Method | Path                           | Auth    | Description              |
| ------ | ------------------------------ | ------- | ------------------------ |
| GET    | `/assignments`                 | Teacher | List assignments         |
| POST   | `/assignments`                 | Teacher | Create new assignment    |
| GET    | `/assignments/:id`             | Teacher | Get assignment           |
| GET    | `/assignments/:id/submissions` | Teacher | View student submissions |
| POST   | `/assignments/:id/submit`      | Student | Submit assignment        |

---

### 🧪 **Module: Exam**

| Method | Path                    | Auth      | Description                |
| ------ | ----------------------- | --------- | -------------------------- |
| GET    | `/exams`                | Admin, SA | List exams                 |
| POST   | `/exams`                | Admin     | Create exam                |
| GET    | `/exam_sessions`        | Admin     | List exam sessions         |
| POST   | `/results`              | Teacher   | Post results for a session |
| GET    | `/students/:id/results` | Student   | View student results       |

---

### 📆 **Module: Calendar**

| Method | Path                                | Auth      | Description             |
| ------ | ----------------------------------- | --------- | ----------------------- |
| GET    | `/calendar-events`                  | All Roles | View calendar           |
| POST   | `/calendar-events`                  | Admin     | Create calendar event   |
| GET    | `/calendar-events/:id/participants` | Admin     | View event participants |

---

## 4.4 ❗ Standardized Error Handling Format

| Field     | Type   | Description                                      |
| --------- | ------ | ------------------------------------------------ |
| `code`    | string | Application-specific code (e.g., `INVALID_ROLE`) |
| `message` | string | Human-readable summary                           |
| `details` | object | Optional; domain-specific debug info             |

All errors return HTTP 4xx/5xx with a structured body. No stack traces exposed.

---

## 4.5 🔐 Authentication & Security

### 🛡️ Authentication Strategy

- **JWT Bearer Token** for stateless client auth (web + mobile)
- Tokens passed via header:

```http
Authorization: Bearer <token>
```

- Expiration: 15 min access + 7d refresh
- All routes protected via middleware except `/auth/*`

### 🔐 Token Payload (JWT)

```ts
interface JWTPayload {
  userId: string;
  role: "student" | "teacher" | "admin" | "superadmin";
  permissions: string[];
  exp: number;
}
```

---

### 🧯 Rate Limiting & Security Headers

| Control        | Value                                                           |
| -------------- | --------------------------------------------------------------- |
| **Rate Limit** | 100 reqs/min per IP (default)                                   |
| **CORS**       | Whitelisted per environment                                     |
| **Headers**    | `X-Content-Type-Options`, `X-Frame-Options`, `X-XSS-Protection` |

---
