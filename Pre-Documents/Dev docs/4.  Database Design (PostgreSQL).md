This section reflects **real-world standards** for building an optimized, secure, scalable, and maintainable database layer for a modular **School Management System**. The design intentionally supports **true modular separation**, **horizontal extensibility**, and **clean DI boundaries** by avoiding overly coupled or leaky relational structures.

---

### 📐 3.1 Entity-Relationship Design (ERD)

The PostgreSQL database schema adheres to strict normalization, ensuring:

- **Modular table design** aligned with backend domains (e.g., StudentModule, ExamModule, etc.)
- Use of **UUID** as a default PK type for global uniqueness
- All entities have timestamps and `deleted_at` for auditing and soft-deletion
- Many-to-many relations handled via **pivot tables**
- Avoidance of cyclic dependencies and bidirectional tight coupling

#### ⚙️ Core Domain Modules (Mirrored in ERD):

- **Auth & Identity:** `users`, `roles`, `permissions`, `user_roles`, `user_sessions`
- **Academics:** `classes`, `sections`, `subjects`, `assignments`, `submissions`
- **People:** `students`, `parents`, `teachers`, `parent_student_links`
- **Assessment:** `exams`, `exam_sessions`, `results`, `grades`
- **Attendance & Leaves:** `attendance_records`, `leave_requests`, `calendar_events`
- **Finance:** `fee_structures`, `fee_payments`, `student_fee_mappings`
- **Communication:** `notices`, `notice_targets`, `complaints`, `messages`, `conversations`
- **Platform Logs:** `audit_logs`, `activity_streams`

> Each module is managed via a strict **bounded context**, and foreign keys are only allowed between **explicitly allowed domains**.

---

### 🧬 3.2 Schema Design: Tables, Columns, Types, Relations, Indexes

Every table will follow:

- **Naming pattern:** `snake_case`
- **Primary Key:** `id UUID DEFAULT gen_random_uuid()`
- **Auditing columns:** `created_at`, `updated_at`, `deleted_at`
- **Indexing:** Composite indexes for frequent queries (e.g., `class_id + section_id`)
- **JSONB columns:** Where domain requires flexible custom data (e.g., `additional_metadata`)

---

#### 🧑‍🎓 `students` Table

| Column                | Type        | Notes                         |
| --------------------- | ----------- | ----------------------------- |
| `id`                  | UUID (PK)   | Primary key                   |
| `user_id`             | UUID        | FK → `users.id`, unique       |
| `class_id`            | UUID        | FK → `classes.id`             |
| `section_id`          | UUID        | FK → `sections.id`            |
| `roll_number`         | VARCHAR(20) | Unique per class-section      |
| `dob`                 | DATE        |                               |
| `gender`              | ENUM        | ('male', 'female', 'other')   |
| `additional_metadata` | JSONB       | Dynamic student-specific data |
| `created_at`          | TIMESTAMPTZ | Default `now()`               |
| `updated_at`          | TIMESTAMPTZ |                               |
| `deleted_at`          | TIMESTAMPTZ | Nullable (for soft-delete)    |

**Indexes:**

- `UNIQUE (class_id, section_id, roll_number)`
- `INDEX ON (class_id)`
- `INDEX ON (user_id)`

---

#### 🧑‍🏫 `teachers`, `parents` Table (mirror structure)

- Link to `users` table
- Contain only role-specific fields (e.g., `designation`, `qualification`, `relationship`)
- All cross-linking happens via **join tables**: `parent_student_links`, `teacher_subject_assignments`

---

#### 📚 `assignments`, `submissions`

- Assignments are linked to `subjects`, `classes`, `teachers`
- Submissions link to `students`, support `grade`, `feedback`, timestamps
- `file_links` (JSONB) to store S3 URLs securely

---

#### 📊 `exams`, `exam_sessions`, `results`

- Exams have multiple sessions
- Results table normalized into:
  - `student_id`
  - `exam_session_id`
  - `marks_obtained`, `grade`, `remarks`
  - `is_passed` (boolean)
  - Indexed by `student_id`, `exam_id`

---

### 🗂️ 3.3 List of Schema Modules

| Module            | Schema Tables                                                                 |     |
| ----------------- | ----------------------------------------------------------------------------- | --- |
| **auth**          | `users`, `roles`, `permissions`, `user_roles`, `user_sessions`                |     |
| **student**       | `students`, `parent_student_links`, `student_profiles`                        |     |
| **teacher**       | `teachers`, `teacher_subjects`, `teacher_profiles`                            |     |
| **academics**     | `classes`, `sections`, `subjects`, `assignments`, `submissions`               |     |
| **exam**          | `exams`, `exam_sessions`, `results`, `grades`                                 |     |
| **attendance**    | `attendance_records`, `leave_requests`, `absentee_flags`                      |     |
| **finance**       | `fee_structures`, `payments`, `discounts`, `invoices`, `student_fee_mappings` |     |
| **communication** | `notices`, `complaints`, `messages`, `conversations`                          |     |
| **calendar**      | `calendar_events`, `event_participants`, `school_day_config`                  |     |
| **configuration** | `school_profile`, `academic_years`, `grading_policies`, `subject_mappings`    |     |
| **platform**      | `audit_logs`, `activity_logs`, `feature_flags`, `global_settings`             |     |
| **forum**         | `forums`, `forum_threads`, `forum_posts`, `moderation_flags`                  |     |
| **files**         | `file_uploads`, `file_links`                                                  |     |
| **feedback**      | `feedback_forms`, `responses`, `suggestions`                                  |     |
| **achievements**  | `certificates`, `badges`, `student_achievements`                              |     |

> Each schema is isolated per module — promoting testability, migration safety, and clean rollback.

---

### 🔐 3.4 Auditing & Soft-Delete Design

Every auditable table includes:

- `created_by`, `updated_by`, `deleted_by` (UUID → `users.id`)
- `created_at`, `updated_at`, `deleted_at` (TIMESTAMPTZ)
- `audit_logs` table captures:
  - `action`: ENUM (create/update/delete/login)
  - `resource`: ENUM or table name
  - `previous_state`, `new_state` (JSONB diffs)
  - `performed_by`, `ip_address`, `user_agent`

---

### 📤 3.5 Migration Strategy & Tools

**Preferred Tool:** Prisma (PostgreSQL adapter)

#### Why Prisma?

- Type-safe schema modeling (excellent with TypeScript)
- Can be used in CLI-driven migrations and programmatic runtime client
- Good support for modular schema via `schema.prisma` per context

#### Best Practices:

- `prisma migrate dev` → for local
- `prisma migrate deploy` → CI/CD pipeline
- Version-control all migration files under `src/database/migrations/{module}`

---

### 🌱 3.6 Seed Data Strategy

- Seed scripts per module stored in `/database/seeds/{module}`
- Initial dataset:
  - Super Admin
  - Sample school year, class, sections
  - Demo students, teachers, roles
  - Sample exam + results
  - Sample fee structure + payment

Use:

```bash
npm run db:seed
```

Behind the scenes, each seed:

- Clears old data (unless in `--append` mode)
- Seeds using Prisma's `createMany`
- Logs to `seed_audit` table for traceability

---
