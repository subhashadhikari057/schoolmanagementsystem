## üìò API Contract ‚Äî `Platform Module`

> **Version:** `v1`  
> **Base Path:** `/api/v1/platform`  
> **Auth Required:** ‚úÖ JWT  
> **Roles Permitted:** `SuperAdmin`, `Admin`

---

### üîê Access Control Rules

| Action                   | Role(s)           | Scope                                           |
| ------------------------ | ----------------- | ----------------------------------------------- |
| List audit logs          | SuperAdmin, Admin | All audit logs                                  |
| View single audit log    | SuperAdmin, Admin | Specific audit log entry                        |
| List activity logs       | SuperAdmin, Admin | All activity logs                               |
| View single activity log | SuperAdmin, Admin | Specific activity log entry                     |
| List feature flags       | SuperAdmin, Admin | All feature flags                               |
| Create feature flag      | SuperAdmin, Admin | Add new feature flag                            |
| Update feature flag      | SuperAdmin, Admin | Modify existing feature flag                    |
| Delete feature flag      | SuperAdmin, Admin | **Soft-delete and trigger orphan-link cleanup** |
| Get global settings      | SuperAdmin, Admin | Current global settings                         |
| Update global settings   | SuperAdmin, Admin | Modify global settings                          |

---

### üìö Endpoint Catalog

| Method | Path                 | Description                                        | Auth & Roles      |
| ------ | -------------------- | -------------------------------------------------- | ----------------- |
| GET    | `/audit-logs`        | List audit logs (paginated)                        | SuperAdmin, Admin |
| GET    | `/audit-logs/:id`    | Get audit log entry by ID                          | SuperAdmin, Admin |
| GET    | `/activity-logs`     | List activity logs (paginated)                     | SuperAdmin, Admin |
| GET    | `/activity-logs/:id` | Get activity log entry by ID                       | SuperAdmin, Admin |
| GET    | `/feature-flags`     | List all feature flags                             | SuperAdmin, Admin |
| POST   | `/feature-flags`     | Create a new feature flag                          | SuperAdmin, Admin |
| GET    | `/feature-flags/:id` | Get feature flag by ID                             | SuperAdmin, Admin |
| PUT    | `/feature-flags/:id` | Update feature flag                                | SuperAdmin, Admin |
| DELETE | `/feature-flags/:id` | **Soft-delete feature flag & clean up file links** | SuperAdmin, Admin |
| GET    | `/global-settings`   | Get global settings                                | SuperAdmin, Admin |
| PUT    | `/global-settings`   | Update global settings                             | SuperAdmin, Admin |

---

### üßæ TypeScript Schemas

#### `AuditLogResponse`

```ts
interface AuditLogResponse {
  id: string;
  action: "create" | "update" | "delete" | "login" | "logout" | "other";
  resource: string;
  resource_id?: string;
  previous_state?: Record<string, any>;
  new_state?: Record<string, any>;
  performed_by: string;
  ip_address?: string;
  user_agent?: string;
  created_at: string;
}
```

#### `ActivityLogResponse`

```ts
interface ActivityLogResponse {
  id: string;
  user_id: string;
  activity_type: string;
  details?: Record<string, any>;
  ip_address?: string;
  user_agent?: string;
  created_at: string;
}
```

#### `FeatureFlagRequest`

```ts
interface FeatureFlagRequest {
  key: string;
  description?: string;
  is_enabled: boolean;
  rollout_percentage?: number; // 0‚Ää‚Äì‚Ää100
  conditions?: Record<string, any>; // optional targeting rules
  additional_metadata?: Record<string, any>;
}
```

#### `FeatureFlagResponse`

```ts
interface FeatureFlagResponse {
  id: string;
  key: string;
  description?: string;
  is_enabled: boolean;
  rollout_percentage?: number;
  conditions?: Record<string, any>;
  additional_metadata?: Record<string, any>;
  created_at: string;
  updated_at: string;
  deleted_at?: string | null;
}
```

#### `GlobalSettingsRequest`

```ts
interface GlobalSettingsRequest {
  school_name?: string;
  school_address?: string;
  default_language?: string;
  timezone?: string;
  contact_email?: string;
  contact_phone?: string;
  additional_metadata?: Record<string, any>;
}
```

#### `GlobalSettingsResponse`

```ts
interface GlobalSettingsResponse {
  id: string;
  school_name: string;
  school_address: string;
  default_language: string;
  timezone: string;
  contact_email: string;
  contact_phone: string;
  additional_metadata?: Record<string, any>;
  created_at: string;
  updated_at: string;
}
```

---

### ‚ö†Ô∏è Standard Error Object

```ts
interface ErrorResponse {
  statusCode: number;
  error: string;
  message: string;
  code?: string; // e.g. FEATURE_FLAG_INVALID, NOT_FOUND
}
```

---

### üîê Security Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
X-Request-ID: <uuid>   # optional tracing
```

---

### üîó Orphan-Link Cleanup Guidance

When a **feature flag** (or any platform record) is soft-deleted, the backend **MUST**:

1. **Cascade-clean** associated links in `files.file_links` and other polymorphic-link tables.
2. Remove rows in other modules that reference the orphaned `linked_id`.

#### Suggested cron / maintenance SQL

```sql
-- nightly orphan sweep
DELETE FROM files.file_links fl
WHERE NOT EXISTS (
  SELECT 1
  FROM pg_class c
  WHERE c.relname = fl.linked_table
);
```

#### Example runtime cleanup

```ts
await sql`
  DELETE FROM files.file_links
  WHERE linked_table = 'feature_flags'
    AND linked_id    = ${flagId};
`;
```

---

### ‚úÖ Role Constraints & Guards

- Only **SuperAdmin** and **Admin** can access any route in this module.
- Audit & activity logs are **append-only** ‚Äì no update/delete beyond system writes.

---

### üìã Sample Flow ‚Äì Delete Feature Flag

```http
DELETE /feature-flags/flag123
Authorization: Bearer <JWT_TOKEN>
```

_Server workflow_:

```ts
await deleteFeatureFlag(flagId); // soft-delete row
await linkService.cleanup("feature_flags", flagId); // remove dangling links
```

Returns `204 No Content` on success.

---
