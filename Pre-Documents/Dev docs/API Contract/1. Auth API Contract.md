## 🔐 API Contract — `Auth Module`

> Version: `v1`  
> Base Path: `/api/v1/auth`  
> Auth Required: ❌ For public routes (login, register, reset)  
> Roles Issued: `SuperAdmin`, `Admin`, `Teacher`, `Parent`, `Student`

---

### 🔐 Access Control Rules

| Action                    | Endpoint                  | Auth                        | Description                                                                              |
| ------------------------- | ------------------------- | --------------------------- | ---------------------------------------------------------------------------------------- |
| Login                     | `/login`                  | ❌                          | Issue JWT token after verifying credentials                                              |
| Logout                    | `/logout`                 | ✅                          | Invalidate session or token on client                                                    |
| Refresh Token             | `/refresh`                | ❌ (Requires refresh token) | Refresh access token                                                                     |
| Register (Student/Parent) | `/register`               | ❌                          | Register a user role if self-registration allowed (returns 409 on duplicate email/phone) |
| Password Reset Request    | `/password/request-reset` | ❌                          | Email-based reset trigger                                                                |
| Password Reset            | `/password/reset`         | ❌                          | Submit reset code and new password                                                       |
| Change Password           | `/password/change`        | ✅                          | Logged-in user password change                                                           |
| Get Current User          | `/me`                     | ✅                          | Return logged-in user identity + role info                                               |

---

### 📚 Endpoint Catalog

| Method | Path                      | Description                                                                   | Auth Required      | Roles        |
| ------ | ------------------------- | ----------------------------------------------------------------------------- | ------------------ | ------------ |
| POST   | `/login`                  | Login with email/phone and password                                           | No                 | All          |
| POST   | `/logout`                 | Logout current session                                                        | Yes                | All          |
| POST   | `/refresh`                | Refresh JWT using refresh token                                               | No (token in body) | All          |
| GET    | `/me`                     | Get current session identity                                                  | Yes                | All          |
| POST   | `/register`               | Register (if self-signup allowed). Returns 409 if email/phone already exists. | No                 | Configurable |
| POST   | `/password/request-reset` | Request reset code via email/phone                                            | No                 | All          |
| POST   | `/password/reset`         | Submit new password with valid code                                           | No                 | All          |
| POST   | `/password/change`        | Change password (logged in)                                                   | Yes                | All          |

---

### 🧾 TypeScript Schemas

#### 🔐 `LoginRequest`

```ts
interface LoginRequest {
  identifier: string; // email or phone
  password: string;
}
```

#### ✅ `LoginResponse`

```ts
interface LoginResponse {
  access_token: string;
  refresh_token: string;
  expires_in: number; // seconds
  user: {
    id: string;
    full_name: string;
    role: "admin" | "student" | "teacher" | "parent" | "superadmin";
  };
}
```

---

#### 🆕 `RefreshTokenRequest`

```ts
interface RefreshTokenRequest {
  refresh_token: string;
}
```

#### ✅ `RefreshTokenResponse`

```ts
interface RefreshTokenResponse {
  access_token: string;
  expires_in: number;
}
```

---

#### 🙋 `RegisterRequest`

> Only if the system allows self-registration (typically for students or parents)

```ts
interface RegisterRequest {
  full_name: string;
  email: string;
  phone?: string;
  password: string;
  role: "student" | "parent";
  metadata?: Record<string, any>; // optional JSONB metadata
}
```

---

### 🚨 Duplicate Email/Phone Handling

When a user attempts to register with an `email` or `phone` that already exists:

- The server MUST catch Postgres unique constraint errors (code `23505`)
- Respond with HTTP `409 Conflict` and a structured error:

```ts
{
  statusCode: 409,
  error: "Conflict",
  message: "Email already in use",
  code: "DUPLICATE_EMAIL"
}
```

> Applies to constraints like:
>
> ```sql
> ALTER TABLE auth.users ADD CONSTRAINT unique_email UNIQUE(email);
> ```

---

#### 📩 `RequestPasswordReset`

```ts
interface RequestPasswordReset {
  identifier: string; // email or phone
}
```

#### 🔑 `PasswordResetRequest`

```ts
interface PasswordResetRequest {
  token: string; // code sent to user
  new_password: string;
}
```

---

#### 🔐 `ChangePasswordRequest`

```ts
interface ChangePasswordRequest {
  current_password: string;
  new_password: string;
}
```

---

#### 👤 `MeResponse`

```ts
interface MeResponse {
  id: string;
  full_name: string;
  email: string;
  phone?: string;
  role: "admin" | "student" | "teacher" | "parent" | "superadmin";
  permissions: string[]; // optional future use
}
```

---

### ⚠️ Standard Error Format

```ts
interface ErrorResponse {
  statusCode: number;
  error: string; // e.g., "Unauthorized"
  message: string; // e.g., "Invalid credentials"
  code?: string; // e.g., INVALID_PASSWORD, USER_NOT_FOUND, DUPLICATE_EMAIL
}
```

---

### 🔐 Security & Auth Tokens

All protected endpoints require:

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

Tokens:

- **Access Token**: short-lived JWT
- **Refresh Token**: long-lived, single-use per rotation (stored HTTP-only cookie or mobile store)
- **Session Rotation**: Enforced by refresh endpoint
- **Revocation**: Client-side logout or expired refresh token

---

### 🧠 Additional Notes

- Authentication is email/phone-based depending on system config
- JWT payload includes `user_id`, `role`, `exp`
- Role guards applied at route/middleware level
- Tokens should be signed using RS256 (public/private key pair)
- If mobile support is required, refresh token rotation is mandatory
- Optionally store refresh token fingerprint with device_id for security

---

### 🔐 Role Access Summary

| Role       | Can Login | Self-register     | Change Password | Password Reset |
| ---------- | --------- | ----------------- | --------------- | -------------- |
| SuperAdmin | ✅        | ❌                | ✅              | ✅             |
| Admin      | ✅        | ❌                | ✅              | ✅             |
| Teacher    | ✅        | ❌                | ✅              | ✅             |
| Parent     | ✅        | ✅ (configurable) | ✅              | ✅             |
| Student    | ✅        | ✅ (configurable) | ✅              | ✅             |

---

### 🧪 Sample Flows

#### 1. Login Flow

- `POST /auth/login` → `{ identifier, password }`
- On success → `access_token + refresh_token`

#### 2. Refresh Flow

- `POST /auth/refresh` → `{ refresh_token }`
- On success → `access_token`

#### 3. Password Reset

- `POST /auth/password/request-reset` → `{ email }`
- Receive token via email
- `POST /auth/password/reset` → `{ token, new_password }`

---
