---

## üìò API Contract ‚Äî `Files Module`

> **Version:** `v1`  
> **Base Path:** `/api/v1/files`  
> **Auth Required:** ‚úÖ JWT  
> **Roles Permitted:** `SuperAdmin`, `Admin`, `Teacher`, `Student`, `Parent`

---

### üîê Access Control Rules

| Action               | Role(s)                      | Scope / Notes                                    |
| -------------------- | ---------------------------- | ------------------------------------------------ |
| List uploaded files  | All roles                    | Files owned or accessible by user                |
| Upload file          | All roles                    | Respect type/size limits                         |
| Get file metadata    | All roles                    | File must be accessible                          |
| Download file        | All roles                    | Requires permission                              |
| Update file metadata | SuperAdmin, Admin            | Edit description / tags                          |
| Delete (soft) file   | SuperAdmin, Admin, **Owner** | Soft-delete **and** trigger `file_links` cleanup |
| Link file to entity  | All roles (within scope)     | E.g., assignment submission, profile photo       |
| Unlink file          | SuperAdmin, Admin            | Remove link entry                                |

---

### üìö Endpoint Catalog

| Method | Path                         | Description                          | Auth & Roles             |
| ------ | ---------------------------- | ------------------------------------ | ------------------------ |
| GET    | `/uploads`                   | List files (paginated)               | Authenticated            |
| POST   | `/uploads`                   | Upload a new file                    | Authenticated            |
| GET    | `/uploads/:file_id`          | Get file metadata                    | Authenticated            |
| GET    | `/uploads/:file_id/download` | Download file content                | Authenticated            |
| PUT    | `/uploads/:file_id`          | Update file metadata                 | SuperAdmin, Admin        |
| DELETE | `/uploads/:file_id`          | Soft-delete file **+ cleanup links** | SuperAdmin, Admin, Owner |
| POST   | `/links`                     | Create file link to entity           | Authenticated            |
| DELETE | `/links/:link_id`            | Delete file link                     | SuperAdmin, Admin        |

---

### üßæ TypeScript Schemas

#### `FileUploadRequest`

```ts
interface FileUploadRequest {
  filename: string;
  content_type: string;
  size: number;
  description?: string;
  metadata?: Record<string, any>;
  file_data: Blob | string; // binary | base64
}
```

#### `FileUploadResponse`

```ts
interface FileUploadResponse {
  id: string;
  filename: string;
  content_type: string;
  size: number;
  description?: string;
  metadata?: Record<string, any>;
  uploaded_by: string; // user_id
  uploaded_at: string;
  deleted_at?: string | null;
}
```

#### `FileMetadataResponse`

```ts
interface FileMetadataResponse extends FileUploadResponse {}
```

#### `UpdateFileMetadataRequest`

```ts
interface UpdateFileMetadataRequest {
  description?: string;
  metadata?: Record<string, any>;
}
```

#### `CreateFileLinkRequest`

```ts
interface CreateFileLinkRequest {
  file_id: string;
  entity_type:
    | "assignment_submission"
    | "student_profile"
    | "teacher_profile"
    | "other";
  entity_id: string;
}
```

#### `FileLinkResponse`

```ts
interface FileLinkResponse {
  id: string;
  file_id: string;
  entity_type: string;
  entity_id: string;
  linked_at: string;
  linked_by: string; // user_id
}
```

---

### ‚ö†Ô∏è Standard Error Object

```ts
interface ErrorResponse {
  statusCode: number;
  error: string;
  message: string;
  code?: string; // FILE_NOT_FOUND, PERMISSION_DENIED, etc.
}
```

---

### üîê Security Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: multipart/form-data   # for uploads
X-Request-ID: <uuid>                # optional tracing
```

---

### üîó Relations & Orphan-Link Cleanup

- `files.file_links` is a **polymorphic** link table (`linked_table`, `linked_id`).
- **Every delete** of a file **or** its parent domain object must remove dangling links.

‚úÖ **Centralized cleanup service example**

```ts
export async function cleanupFileLinks(fileId: string) {
  await db.delete("file_links").where({ file_id: fileId });
}
```

‚úÖ **Nightly cron SQL (catch-all):**

```sql
DELETE FROM files.file_links
WHERE NOT EXISTS (
  SELECT 1
  FROM pg_class c
  WHERE c.relname = linked_table
);
```

---

### ‚úÖ Role Constraints & Guards

| Role            | Upload | Update / Delete Own | Update / Delete Others |
| --------------- | ------ | ------------------- | ---------------------- |
| SuperAdmin      | ‚úÖ     | ‚úÖ                  | ‚úÖ                     |
| Admin           | ‚úÖ     | ‚úÖ                  | ‚úÖ                     |
| Teacher/Student | ‚úÖ     | ‚úÖ (own files)      | ‚ùå                     |
| Parent          | ‚úÖ     | ‚úÖ (own files)      | ‚ùå                     |

---

### üìã Sample Flows

#### 1. **Upload & Link**

```http
POST /uploads                    # multipart/form-data
```

‚Üí `FileUploadResponse` ‚Üí then:

```http
POST /links
```

```json
{
  "file_id": "file-uuid",
  "entity_type": "assignment_submission",
  "entity_id": "submission-uuid"
}
```

#### 2. **Delete File (auto-cleanup)**

```http
DELETE /uploads/file-uuid
```

Server steps:

```ts
await softDeleteFile(fileId);
await cleanupFileLinks(fileId);
```

#### 3. **Cron Orphan Sweep**

Runs nightly:

```sql
DELETE FROM files.file_links
WHERE NOT EXISTS (
  SELECT 1 FROM pg_class c
  WHERE c.relname = linked_table
);
```

Keeps the system free of ghost links that would otherwise break UI downloads.

---
