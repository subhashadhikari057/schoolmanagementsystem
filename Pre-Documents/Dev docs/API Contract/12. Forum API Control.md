## üìò API Contract ‚Äî `Forum Module`

> **Version:** `v1`  
> **Base Path:** `/api/v1/forum`  
> **Auth Required:** ‚úÖ JWT  
> **Roles Permitted:** `SuperAdmin`, `Admin`, `Teacher`, `Student`, `Parent`

---

### üîê Access Control Rules

| Action                   | Role(s)                                     | Scope                                        |
| ------------------------ | ------------------------------------------- | -------------------------------------------- |
| List forums              | All authenticated users                     | All forums                                   |
| Create forum             | SuperAdmin, Admin                           | Create new forums                            |
| Get forum details        | All authenticated users                     | Specific forum details                       |
| Update forum             | SuperAdmin, Admin                           | Modify forum details                         |
| Delete (soft) forum      | SuperAdmin, Admin                           | Soft-delete forum                            |
| List threads             | All authenticated users                     | Threads in a specific forum                  |
| Create thread            | SuperAdmin, Admin, Teacher, Student, Parent | Add thread in forum                          |
| Get thread details       | All authenticated users                     | Thread detail with posts                     |
| Update thread            | SuperAdmin, Admin, **Thread owner**         | Edit thread title/description                |
| Delete (soft) thread     | SuperAdmin, Admin, **Thread owner**         | Soft-delete thread                           |
| List posts               | All authenticated users                     | Posts within a thread                        |
| Create post              | SuperAdmin, Admin, Teacher, Student, Parent | Post reply in thread                         |
| Update post              | SuperAdmin, Admin, **Post owner**           | Edit post content                            |
| Delete (soft) post       | SuperAdmin, Admin, **Post owner**           | Soft-delete post                             |
| Flag post for moderation | All authenticated users                     | Flag inappropriate posts                     |
| Review moderation flags  | SuperAdmin, Admin                           | Review flagged posts                         |
| Moderate posts/threads   | SuperAdmin, Admin                           | Approve, delete, lock, or mark threads/posts |

---

### üìö Endpoint Catalog

| Method | Path                         | Description                   | Auth & Roles                                |
| ------ | ---------------------------- | ----------------------------- | ------------------------------------------- |
| GET    | `/forums`                    | List all forums (paginated)   | Authenticated                               |
| POST   | `/forums`                    | Create new forum              | SuperAdmin, Admin                           |
| GET    | `/forums/:forum_id`          | Get forum details             | Authenticated                               |
| PUT    | `/forums/:forum_id`          | Update forum                  | SuperAdmin, Admin                           |
| DELETE | `/forums/:forum_id`          | Soft-delete forum             | SuperAdmin, Admin                           |
| GET    | `/forums/:forum_id/threads`  | List threads in a forum       | Authenticated                               |
| POST   | `/forums/:forum_id/threads`  | Create a new thread in forum  | SuperAdmin, Admin, Teacher, Student, Parent |
| GET    | `/threads/:thread_id`        | Get thread details + posts    | Authenticated                               |
| PUT    | `/threads/:thread_id`        | Update thread                 | SuperAdmin, Admin, Thread owner             |
| DELETE | `/threads/:thread_id`        | Soft-delete thread            | SuperAdmin, Admin, Thread owner             |
| GET    | `/threads/:thread_id/posts`  | List posts in thread          | Authenticated                               |
| POST   | `/threads/:thread_id/posts`  | Create a post in thread       | SuperAdmin, Admin, Teacher, Student, Parent |
| PUT    | `/posts/:post_id`            | Update post                   | SuperAdmin, Admin, Post owner               |
| DELETE | `/posts/:post_id`            | Soft-delete post              | SuperAdmin, Admin, Post owner               |
| POST   | `/posts/:post_id/flags`      | Flag a post for moderation    | Authenticated                               |
| GET    | `/moderation/flags`          | List all flagged posts        | SuperAdmin, Admin                           |
| PUT    | `/moderation/flags/:flag_id` | Update moderation-flag status | SuperAdmin, Admin                           |

---

### üßæ TypeScript Schemas

#### **ENUMs**

```ts
type ThreadStatus = "active" | "archived" | "locked";
type PostStatus = "active" | "hidden" | "deleted";
```

---

#### `CreateForumRequest`

```ts
interface CreateForumRequest {
  name: string;
  description?: string;
  additional_metadata?: Record<string, any>;
}
```

#### `ForumResponse`

```ts
interface ForumResponse {
  id: string;
  name: string;
  description?: string;
  created_at: string;
  updated_at?: string;
  deleted_at?: string | null;
  additional_metadata?: Record<string, any>;
}
```

---

#### `UpdateForumRequest`

```ts
interface UpdateForumRequest {
  name?: string;
  description?: string;
  additional_metadata?: Record<string, any>;
}
```

---

#### `CreateThreadRequest`

```ts
interface CreateThreadRequest {
  forum_id: string;
  title: string;
  content: string;
  status?: ThreadStatus; // defaults to 'active'
  additional_metadata?: Record<string, any>;
}
```

#### `ThreadResponse`

```ts
interface ThreadResponse {
  id: string;
  forum_id: string;
  title: string;
  content: string;
  status: ThreadStatus; // ENUM enforced
  created_by: string;
  created_at: string;
  updated_at?: string;
  deleted_at?: string | null;
  additional_metadata?: Record<string, any>;
}
```

---

#### `UpdateThreadRequest`

```ts
interface UpdateThreadRequest {
  title?: string;
  content?: string;
  status?: ThreadStatus;
  additional_metadata?: Record<string, any>;
}
```

---

#### `CreatePostRequest`

```ts
interface CreatePostRequest {
  thread_id: string;
  content: string;
  status?: PostStatus; // defaults to 'active'
  additional_metadata?: Record<string, any>;
}
```

#### `PostResponse`

```ts
interface PostResponse {
  id: string;
  thread_id: string;
  content: string;
  status: PostStatus; // ENUM enforced
  created_by: string;
  created_at: string;
  updated_at?: string;
  deleted_at?: string | null;
  additional_metadata?: Record<string, any>;
}
```

---

#### `UpdatePostRequest`

```ts
interface UpdatePostRequest {
  content?: string;
  status?: PostStatus;
  additional_metadata?: Record<string, any>;
}
```

---

#### `CreateFlagRequest`

```ts
interface CreateFlagRequest {
  post_id: string;
  reason: string;
  details?: string;
}
```

#### `FlagResponse`

```ts
interface FlagResponse {
  id: string;
  post_id: string;
  flagged_by: string;
  reason: string;
  details?: string;
  status: "pending" | "reviewed" | "dismissed" | "action_taken";
  created_at: string;
  reviewed_at?: string;
  reviewed_by?: string;
}
```

---

### ‚ö†Ô∏è Standard Error Object

```ts
interface ErrorResponse {
  statusCode: number;
  error: string;
  message: string;
  code?: string; // THREAD_NOT_FOUND, PERMISSION_DENIED, etc.
}
```

---

### üîê Security Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
X-Request-ID: <uuid>
```

---

### üîó ENUM Enforcement Notes

> **Database alignment**

```sql
CREATE TYPE forum_thread_status AS ENUM ('active', 'archived', 'locked');
CREATE TYPE forum_post_status   AS ENUM ('active', 'hidden', 'deleted');

ALTER TABLE forum.threads ALTER COLUMN status TYPE forum_thread_status
  USING status::forum_thread_status;

ALTER TABLE forum.posts   ALTER COLUMN status TYPE forum_post_status
  USING status::forum_post_status;
```

- Matches the TypeScript unions used above.
- Prevents typos like `lockd`, `hiden`, etc.
- Enables reliable filtering & moderation logic.

---

### ‚úÖ Role Constraints & Guards

- **Admins / SuperAdmins:** full moderation, CRUD on any forum content.
- **Owners:** can edit / delete their own threads or posts.
- **Teachers / Students / Parents:** can create content but only within permitted forums.

---

### üìã Sample Flows

**1. Create a Locked Thread**

```http
POST /forums/abc123/threads
```

```json
{
  "title": "Forum Rules",
  "content": "Please read and adhere to these rules.",
  "status": "locked"
}
```

---

**2. Hide an Inappropriate Post**

```http
PUT /posts/post789
```

```json
{
  "status": "hidden"
}
```

Hides the post from standard thread views until reviewed.

---
