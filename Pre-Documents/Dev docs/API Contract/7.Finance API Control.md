## 📘 API Contract — `Finance Module`

> Version: `v1`  
> Base Path: `/api/v1/finance`  
> Auth Required: ✅ Yes (JWT)  
> Roles Permitted: **SuperAdmin**, **Admin**, **Accountant**, **Parent**, **Student** (view-own only)

---

### 🔐 Access Control Rules

| Action                       | Role(s)                       | Scope                                |
| ---------------------------- | ----------------------------- | ------------------------------------ |
| List fee structures          | Admin, SuperAdmin, Accountant | All                                  |
| Create / update / delete fee | Admin, SuperAdmin             | Global                               |
| Assign fee to students       | Admin, Accountant             | Per student / class                  |
| Make / view payments         | Parent, Student, Admin        | Self / linked children (P) · any (A) |
| Generate invoice             | Admin, Accountant             | Per student or bulk                  |
| Apply discounts              | Admin, Accountant             | By class / student                   |
| View finance summary         | Admin, Accountant, Parent     | Scoped by access                     |
| Export / report fees         | Admin, Accountant             | All or filtered                      |

---

### 📚 Endpoint Catalog

| Method | Path                        | Description                                  | Auth & Roles                       |
| ------ | --------------------------- | -------------------------------------------- | ---------------------------------- |
| GET    | `/fee-structures`           | List fee structures (filters)                | Admin, Accountant, SuperAdmin      |
| POST   | `/fee-structures`           | Create fee structure                         | Admin, SuperAdmin                  |
| PUT    | `/fee-structures/:id`       | Update fee structure                         | Admin, SuperAdmin                  |
| DELETE | `/fee-structures/:id`       | Soft-delete fee structure                    | Admin, SuperAdmin                  |
| GET    | `/student-fees/:student_id` | Get mapped fees for student                  | Admin, Accountant, Parent, Student |
| POST   | `/student-fees/map`         | Map fees → students                          | Admin, Accountant                  |
| GET    | `/invoices/:student_id`     | All invoices for a student                   | Admin, Accountant, Parent          |
| POST   | `/invoices/generate`        | Generate invoice(s)                          | Admin, Accountant                  |
| GET    | `/payments/:student_id`     | All payments by student (filter by `status`) | Admin, Accountant, Parent          |
| POST   | `/payments`                 | Make a payment (defaults `status = pending`) | Parent, Admin                      |
| GET    | `/discounts`                | List available discounts                     | Admin, Accountant                  |
| POST   | `/discounts`                | Create discount                              | Admin, Accountant                  |
| PUT    | `/discounts/:id`            | Update discount                              | Admin                              |
| DELETE | `/discounts/:id`            | Delete discount                              | Admin                              |

---

### 🧾 TypeScript Schemas

#### 🛠️ `CreateFeeStructureRequest`

```ts
interface CreateFeeStructureRequest {
  title: string;
  description?: string;
  frequency: "monthly" | "quarterly" | "annually" | "onetime";
  amount: number;
  applicable_classes: string[]; // class UUIDs
  due_date: string; // ISO date
  metadata?: Record<string, any>;
}
```

#### ✅ `FeeStructureResponse`

```ts
interface FeeStructureResponse {
  id: string;
  title: string;
  frequency: "monthly" | "quarterly" | "annually" | "onetime";
  amount: number;
  applicable_classes: string[];
  due_date: string;
  metadata?: Record<string, any>;
  created_at: string;
  updated_at: string;
}
```

---

#### 🛠️ `MapFeesToStudentsRequest`

```ts
interface MapFeesToStudentsRequest {
  fee_structure_id: string;
  student_ids: string[];
}
```

#### ✅ `StudentFeeMappingResponse`

```ts
interface StudentFeeMappingResponse {
  id: string;
  student_id: string;
  fee_structure_id: string;
  invoice_id?: string;
  amount: number;
  discount_applied?: number;
  due_date: string;
  paid: boolean;
}
```

---

#### 🛠️ `GenerateInvoiceRequest`

```ts
interface GenerateInvoiceRequest {
  student_ids: string[];
  fee_structure_id: string;
  due_date: string;
}
```

#### ✅ `InvoiceResponse`

```ts
type InvoiceStatus = "unpaid" | "partial" | "paid"; // ENUM (DB + TS)

interface InvoiceResponse {
  id: string;
  student_id: string;
  total_amount: number;
  discount_applied?: number;
  paid_amount: number;
  status: InvoiceStatus;
  issued_date: string;
  due_date: string;
}
```

---

#### 🛠️ `PaymentRequest`

```ts
type PaymentMethod = "cash" | "card" | "bank_transfer" | "upi";

interface PaymentRequest {
  invoice_id: string;
  amount: number;
  payment_method: PaymentMethod;
  paid_by: string; // user_id
  notes?: string;
}
```

#### ✅ `PaymentResponse`

```ts
type PaymentStatus = "pending" | "completed" | "failed" | "refunded" | "void"; // NEW ENUM

interface PaymentResponse {
  id: string;
  invoice_id: string;
  amount: number;
  method: PaymentMethod;
  status: PaymentStatus; // ENUM everywhere
  paid_by: string;
  paid_on: string; // ISO datetime
}
```

> **Backend rule**: New payments are created with `status = 'pending'`; webhook / manual reconciliation updates to `completed | failed | refunded | void`.

---

#### 🛠️ `CreateDiscountRequest`

```ts
interface CreateDiscountRequest {
  title: string;
  description?: string;
  amount: number;
  applies_to: "student" | "class";
  student_ids?: string[];
  class_ids?: string[];
}
```

#### ✅ `DiscountResponse`

```ts
interface DiscountResponse {
  id: string;
  title: string;
  amount: number;
  applies_to: "student" | "class";
  student_ids?: string[];
  class_ids?: string[];
  created_at: string;
}
```

---

### ⚠️ Standard Error Object

```ts
interface ErrorResponse {
  statusCode: number;
  error: string;
  message: string;
  code?: string; // e.g. PAYMENT_FAILED, DUPLICATE_FEE
}
```

---

### 🔐 Security Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
X-Request-ID: <uuid>          # optional tracing
```

---

### 🔗 Notes on Relations

- `fee_structure_id` → `finance.fee_structures.id`
- `student_id` → `student.students.id`
- `invoice_id` → `finance.invoices.id`
- ENUMs (`payment_status`, `invoice_status`, `payment_method`) validated in DB **and** TypeScript for perfect parity.

---

### 🛠️ Suggested Postgres DDL Snippet

```sql
-- 1️⃣ ENUMs
CREATE TYPE payment_status AS ENUM ('pending', 'completed', 'failed', 'refunded', 'void');
CREATE TYPE invoice_status AS ENUM ('unpaid', 'partial', 'paid');

-- 2️⃣ payments table excerpt
ALTER TABLE finance.payments
  ALTER COLUMN status TYPE payment_status
  USING status::payment_status,
  ALTER COLUMN status SET DEFAULT 'pending';

-- 3️⃣ invoices table excerpt
ALTER TABLE finance.invoices
  ALTER COLUMN status TYPE invoice_status
  USING status::invoice_status;
```

---

### ✅ Role Constraints & Guards

| Role                   | Capabilities                                                  |
| ---------------------- | ------------------------------------------------------------- |
| **Admin / Accountant** | Full finance CRUD, map fees, generate invoices, mark payments |
| **Parent / Student**   | View / pay own invoices, see discounts                        |
| **SuperAdmin**         | Override everything                                           |

---

### 📋 Sample Flows

#### 1. Assign Monthly Tuition

```json
POST /student-fees/map
{
  "fee_structure_id": "fee123",
  "student_ids": ["stu1","stu2","stu3"]
}
```

Returns `StudentFeeMappingResponse[]`.

#### 2. Generate Invoice

```json
POST /invoices/generate
{
  "student_ids": ["stu1","stu2"],
  "fee_structure_id": "fee123",
  "due_date": "2025-08-01"
}
```

Each invoice starts with `status = "unpaid"`.

#### 3. Parent Makes Payment

```json
POST /payments
{
  "invoice_id": "inv789",
  "amount": 5000,
  "payment_method": "upi",
  "paid_by": "parent_user_id"
}
```

Returns `PaymentResponse` (`status` initially `"pending"` → later `"completed"` after reconciliation).

---
