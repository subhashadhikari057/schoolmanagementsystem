
## 📘 API Contract — `Achievements Module`

> **Version:** `v1`  
> **Base Path:** `/api/v1/achievements`  
> **Auth Required:** ✅ JWT  
> **Roles Permitted:** `SuperAdmin`, `Admin`, `Teacher`, `Student`, `Parent`

---

### 🔐 Access Control Rules

| Action                     | Role(s)                                   | Scope / Notes                          |
| -------------------------- | ----------------------------------------- | -------------------------------------- |
| List certificates          | SuperAdmin, Admin, Teacher, Student, Parent | Filtered by role / linkage            |
| Create certificate         | SuperAdmin, Admin, Teacher               | Must target a valid `student_id`       |
| Get certificate by ID      | SuperAdmin, Admin, Teacher, Student, Parent | Contextual (self / linked)            |
| Update certificate         | SuperAdmin, Admin                        | Edit title, dates, doc URL, etc.       |
| Soft-delete certificate    | SuperAdmin, Admin                        | Logical delete                         |
| List badges                | All roles                                | Visible badge catalogue                |
| Award badge                | SuperAdmin, Admin, Teacher               | To students they teach / oversee       |
| Get student achievements   | All roles (scoped)                       | Aggregates certificates + badges       |

---

### 📚 Endpoint Catalog

| Method | Path                                           | Description                              | Auth & Roles                    |
| ------ | ---------------------------------------------- | ---------------------------------------- | --------------------------------|
| GET    | `/certificates`                               | List certificates (paginated)            | Role-scoped                     |
| POST   | `/certificates`                               | Create certificate                       | SuperAdmin, Admin, Teacher      |
| GET    | `/certificates/:id`                           | Get certificate details                  | Scoped                          |
| PUT    | `/certificates/:id`                           | Update certificate                       | SuperAdmin, Admin               |
| DELETE | `/certificates/:id`                           | Soft-delete certificate                  | SuperAdmin, Admin               |
| GET    | `/badges`                                     | List badges                              | All roles                       |
| POST   | `/badges/award`                               | Award badge to student                   | SuperAdmin, Admin, Teacher      |
| GET    | `/students/:student_id/achievements`          | List all achievements for a student      | Scoped                          |

---

### 🧾 TypeScript Schemas

#### 🛠️ `CreateCertificateRequest`

```ts
interface CreateCertificateRequest {
  student_id: string;          // UUID → students.id
  title: string;
  issued_by: string;
  issued_date: string;         // ISO Date “YYYY-MM-DD”  ←→  DB type DATE
  description?: string;
  document_url?: string;       // text / url
  additional_metadata?: Record<string, any>;
}
```

#### ✅ `CertificateResponse`

```ts
interface CertificateResponse {
  id: string;
  student_id: string;
  title: string;
  issued_by: string;
  issued_date: string;         // ISO Date string
  description?: string;
  document_url?: string;
  additional_metadata?: Record<string, any>;
  created_at: string;
  updated_at: string;
  deleted_at?: string | null;
}
```

#### 🛠️ `UpdateCertificateRequest`

```ts
interface UpdateCertificateRequest {
  title?: string;
  issued_by?: string;
  issued_date?: string;        // must stay ISO Date
  description?: string;
  document_url?: string;
  additional_metadata?: Record<string, any>;
}
```

---

#### 🛠️ `CreateBadgeRequest`

```ts
interface CreateBadgeRequest {
  name: string;
  description?: string;
  icon_url: string;            // URL → DB TEXT  (never NULL)
  category?: string;
  criteria?: string;
}
```

#### ✅ `BadgeResponse`

```ts
interface BadgeResponse {
  id: string;
  name: string;
  description?: string;
  icon_url: string;            // always string  ←→  DB TEXT
  category?: string;
  criteria?: string;
  created_at: string;
  updated_at: string;
}
```

#### 🛠️ `AwardBadgeRequest`

```ts
interface AwardBadgeRequest {
  student_id: string;          // UUID
  badge_id: string;            // UUID
  awarded_by: string;          // UUID
  awarded_at?: string;         // ISO date-time, default now()
  notes?: string;
}
```

---

#### ✅ `StudentAchievementsResponse`

```ts
interface StudentAchievementsResponse {
  certificates: CertificateResponse[];
  badges: BadgeResponse[];
}
```

---

### ⚠️ Standard Error Object

```ts
interface ErrorResponse {
  statusCode: number;
  error: string;
  message: string;
  code?: string;               // e.g. CERTIFICATE_NOT_FOUND
}
```

---

### 🔐 Security Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
X-Request-ID: <uuid>
```

---

### 🔗 **Field-Type Alignment Notes**

| Field           | API TypeScript (client) | DB Column Type | Notes / Constraints                         |
| --------------- | ----------------------- | -------------- | ------------------------------------------- |
| `issued_date`   | string (ISO Date)       | `DATE`         | **NOT** TIMESTAMP; timezone-free            |
| `icon_url`      | string                 | `TEXT`         | must be valid URL; non-null in badges       |
| `awarded_at`    | string \| undefined     | `TIMESTAMPTZ`  | default `now()` on server if omitted        |

> **✅ Validation tip:** Use a shared Zod/Joi schema that parses `issued_date` with `Z.date()` and transforms to `YYYY-MM-DD`, then casts to DATE in SQL layer.

---

### ✅ Role Constraints Summary

| Role        | Create Cert | Update Cert | Delete Cert | Award Badge | View Achievements |
| ----------- | ----------- | ----------- | ----------- | ----------- | ----------------- |
| SuperAdmin  | ✅          | ✅          | ✅          | ✅          | All               |
| Admin       | ✅          | ✅          | ✅          | ✅          | All               |
| Teacher     | ✅          | ❌          | ❌          | ✅          | Own students      |
| Student     | ❌          | ❌          | ❌          | ❌          | Self              |
| Parent      | ❌          | ❌          | ❌          | ❌          | Linked child      |

---

### 📋 Sample Flows

#### 1️⃣ Create Certificate

```http
POST /certificates
```

```json
{
  "student_id": "stu-uuid",
  "title": "Excellence in Science",
  "issued_by": "School Board",
  "issued_date": "2025-06-15",
  "document_url": "https://cdn.school.com/certs/abc.pdf"
}
```

#### 2️⃣ Award Badge

```http
POST /badges/award
```

```json
{
  "student_id": "stu-uuid",
  "badge_id": "badge-uuid",
  "awarded_by": "teacher-uuid",
  "notes": "Great teamwork!"
}
```

#### 3️⃣ Fetch Student Achievements

```http
GET /students/stu-uuid/achievements
```

Returns combined `certificates[]` + `badges[]`, with all dates and URLs typed exactly as above.

---
