
## 📘 API Contract — `Communication Module`

> Version: `v1`  
> Base Path: `/api/v1/communication`  
> Auth Required: ✅ **Yes (JWT)**  
> Roles Permitted: **SuperAdmin**, **Admin**, **Teacher**, **Parent**, **Student**

---

### 🔐 Access Control Rules

|Action|Role(s)|Scope|
|---|---|---|
|List notices|Admin, SuperAdmin, Teacher, Parent, Student|All active notices or those targeted to the caller|
|Create notice|Admin, SuperAdmin|Global or targeted (role / class / section)|
|Get notice by ID|All authenticated|Only notices visible to the caller|
|Update notice|Admin, SuperAdmin|Own / created notices|
|Delete notice (soft)|Admin, SuperAdmin|Own / created notices|
|List complaints|Admin, SuperAdmin, Teacher|Complaints within role scope (paginated)|
|Create complaint|Parent, Student|Own complaints only|
|Get complaint by ID|Related parties|Own or assigned complaints|
|Update complaint status|Admin, Teacher|If assigned or permitted|
|List messages|Any authenticated user|Paginated conversations / messages the user participates in|
|Send message|Any authenticated user|Within an allowed conversation|
|Get conversation threads|Any authenticated user|Paginated list of user’s conversations|

---

### 📚 Endpoint Catalog

|Method|Path|Description|Auth & Roles|
|---|---|---|---|
|**GET**|`/notices`|List notices (filters + pagination `limit`/`offset`)|All authenticated|
|**POST**|`/notices`|Create notice|Admin, SuperAdmin|
|**GET**|`/notices/:id`|Get notice by ID|All authenticated|
|**PUT**|`/notices/:id`|Update notice|Admin, SuperAdmin|
|**DELETE**|`/notices/:id`|Soft-delete notice|Admin, SuperAdmin|
|**GET**|`/complaints`|List complaints (`limit`/`offset` enforced)|Admin, SuperAdmin, Teacher|
|**POST**|`/complaints`|File complaint|Parent, Student|
|**GET**|`/complaints/:id`|Complaint details|Related parties|
|**PUT**|`/complaints/:id`|Update complaint status|Admin, Teacher|
|**GET**|`/messages/conversations`|User’s conversation threads (`limit`/`offset`)|All authenticated|
|**GET**|`/messages/conversations/:id`|Messages in conversation (`limit`/`offset`)|Participants only|
|**POST**|`/messages/conversations/:id`|Send message|Participants only|

> **Pagination Guard:** Every route marked _paginated_ must accept `limit` _(≤ 100, default 20)_ and `offset` _(≥ 0, default 0)_. Requests over these bounds **MUST** return **HTTP 400**.

---

### 🧾 TypeScript Schemas

#### 🛠️ `PaginationQueryParams`

```ts
interface PaginationQueryParams {
  /** Maximum rows to return – default 20, hard-cap 100 */
  limit?: number;
  /** Zero-based offset – default 0 */
  offset?: number;
}
```

> **Server validator (Joi example):**
> 
> ```ts
> const paginationSchema = Joi.object({
>   limit:  Joi.number().max(100).default(20),
>   offset: Joi.number().min(0).default(0)
> });
> ```

---

#### 🛠️ `CreateNoticeRequest`

```ts
interface CreateNoticeRequest {
  title: string;
  content: string;
  target_roles?: ('Student' | 'Teacher' | 'Parent' | 'Admin' | 'SuperAdmin')[];
  target_classes?: string[];   // class UUIDs
  target_sections?: string[];  // section UUIDs
  is_active: boolean;
  metadata?: Record<string, any>;
}
```

#### ✅ `NoticeResponse`

```ts
interface NoticeResponse {
  id: string;
  title: string;
  content: string;
  target_roles: string[];
  target_classes?: string[];
  target_sections?: string[];
  is_active: boolean;
  created_at: string;
  updated_at: string;
  deleted_at?: string | null;
}
```

---

#### 🛠️ `CreateComplaintRequest`

```ts
interface CreateComplaintRequest {
  student_id: string;
  teacher_id?: string;
  subject: string;
  description: string;
  status?: 'open' | 'in_progress' | 'resolved' | 'closed';
  metadata?: Record<string, any>;
}
```

#### ✅ `ComplaintResponse`

```ts
interface ComplaintResponse {
  id: string;
  student_id: string;
  teacher_id?: string;
  subject: string;
  description: string;
  status: 'open' | 'in_progress' | 'resolved' | 'closed';
  created_at: string;
  updated_at: string;
  deleted_at?: string | null;
}
```

---

#### 🛠️ `CreateMessageRequest`

```ts
interface CreateMessageRequest {
  conversation_id: string;
  sender_id: string;
  message: string;
  attachments?: string[];      // file UUIDs
}
```

#### ✅ `MessageResponse`

```ts
interface MessageResponse {
  id: string;
  conversation_id: string;
  sender_id: string;
  message: string;
  attachments?: string[];
  created_at: string;
  read_at?: string | null;
}
```

#### ✅ `ConversationResponse`

```ts
interface ConversationResponse {
  id: string;
  participant_ids: string[];
  last_message?: MessageResponse;
  created_at: string;
  updated_at: string;
}
```

---

### ⚠️ Standard Error Object

```ts
interface ErrorResponse {
  statusCode: number;
  error: string;     // e.g. "Bad Request"
  message: string;   // Human-readable detail
  code?: string;     // Domain code, e.g. INVALID_LIMIT
}
```

---

### 🔐 Security Headers

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
X-Request-ID: <uuid>        # optional tracing
```

---

### 🔗 Notes on Relations

- **Notices** → targeted by roles / classes / sections
    
- **Complaints** → `student_id` + optional `teacher_id`
    
- **Conversations / Messages** → typical chat schema; attachments reference `files.file_uploads.id`
    
- Soft-deletes use `deleted_at`
    

---

### ✅ Role Constraints & Guards

|Role|Key Rights|
|---|---|
|**Admin / SuperAdmin**|Full CRUD on notices & complaints; view all conversations|
|**Teacher**|View & respond to notices / complaints in their classes; participate in conversations with students & parents|
|**Parent / Student**|View targeted notices; file & track own complaints; only their conversations|

---

### 📋 Sample Flows

#### 1️⃣ List Notices (pagination)

```http
GET /notices?limit=20&offset=0
```

_Response_: `NoticeResponse[]` with headers:

```
X-Total-Count: 327
X-Limit: 20
X-Offset: 0
```

#### 2️⃣ Fetch Conversation Messages

```http
GET /messages/conversations/abc123?limit=50&offset=100
```

Returns `MessageResponse[]`; server rejects `limit > 100` with **HTTP 400**.

---
