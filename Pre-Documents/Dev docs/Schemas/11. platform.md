### üóÇÔ∏è Tables Overview:

| Table Name        | Purpose                                          |
| ----------------- | ------------------------------------------------ |
| `audit_logs`      | Immutable, detailed audit trail for data changes |
| `activity_logs`   | Lightweight user/system event tracking           |
| `feature_flags`   | Dynamic feature-toggle management                |
| `global_settings` | Centralized key-value configuration store        |

---

## üìÑ Schema Definitions (PostgreSQL + SQL DDL)

---

### üìú `audit_logs`

```sql
CREATE TABLE platform.audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    action      VARCHAR(20)  NOT NULL,                -- create, update, delete, etc.
    resource    VARCHAR(100) NOT NULL,                -- table or logical resource
    resource_id UUID,                                 -- affected record (optional)

    -- NEW polymorphic link columns
    linked_table VARCHAR(100),                        -- e.g., 'students', 'payments'
    linked_id    UUID,                                -- ID of linked record

    performed_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    performed_at TIMESTAMPTZ DEFAULT now(),

    ip_address INET,
    user_agent TEXT,

    previous_state JSONB,
    new_state      JSONB,

    notes TEXT,

    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_audit_logs_resource       ON platform.audit_logs(resource);
CREATE INDEX idx_audit_logs_performed_by   ON platform.audit_logs(performed_by);
CREATE INDEX idx_audit_logs_performed_at   ON platform.audit_logs(performed_at);
CREATE INDEX idx_audit_logs_linked         ON platform.audit_logs(linked_table, linked_id);
```

---

### üìù `activity_logs`

```sql
CREATE TABLE platform.activity_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    user_id     UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    event_type  VARCHAR(50) NOT NULL,                 -- login_success, file_upload, etc.
    event_details JSONB,                              -- arbitrary metadata

    -- NEW polymorphic link columns
    linked_table VARCHAR(100),
    linked_id    UUID,

    ip_address INET,
    user_agent TEXT,

    occurred_at TIMESTAMPTZ DEFAULT now(),

    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_activity_logs_user_id   ON platform.activity_logs(user_id);
CREATE INDEX idx_activity_logs_event_type ON platform.activity_logs(event_type);
CREATE INDEX idx_activity_logs_occurred_at ON platform.activity_logs(occurred_at);
CREATE INDEX idx_activity_logs_linked     ON platform.activity_logs(linked_table, linked_id);
```

---

### üö© `feature_flags`

```sql
CREATE TABLE platform.feature_flags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    key         VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,

    is_enabled        BOOLEAN  DEFAULT FALSE,
    rollout_percentage SMALLINT DEFAULT 0,            -- 0‚Äì100
    target_roles       UUID[],                        -- array of role IDs
    target_users       UUID[],                        -- array of user IDs

    conditions JSONB,                                -- advanced targeting

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

CREATE INDEX idx_feature_flags_key        ON platform.feature_flags(key);
CREATE INDEX idx_feature_flags_is_enabled ON platform.feature_flags(is_enabled);
```

---

### ‚öôÔ∏è `global_settings`

```sql
CREATE TABLE platform.global_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    key   VARCHAR(150) UNIQUE NOT NULL,
    value JSONB         NOT NULL,                     -- any JSON-serialisable value
    description TEXT,

    is_secret BOOLEAN DEFAULT FALSE,                  -- mask in UI / API

    -- NEW polymorphic link columns
    linked_table VARCHAR(100),
    linked_id    UUID,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

CREATE INDEX idx_global_settings_key    ON platform.global_settings(key);
CREATE INDEX idx_global_settings_linked ON platform.global_settings(linked_table, linked_id);
```

---

## üìå Design Notes & Rationale

- **Polymorphic linkage** ‚Äî Each platform table now supports `linked_table` + `linked_id` to reference any record system-wide (e.g., a log tied to a deleted student).
- **Cleanup responsibility** ‚Äî Service layer or scheduled jobs must null-out or delete links when targets are removed to avoid UI ‚Äúzombie‚Äù data.
- **Indexes on `(linked_table, linked_id)`** enable fast look-ups and cleanup passes.
- `audit_logs` and `activity_logs` remain append-only; no soft-delete columns to preserve immutability.
- All tables still include audit metadata (`created_by`, `updated_by`, `deleted_by`) where applicable.

---
