### 🗂️ Tables Overview:

|Table Name|Purpose|
|---|---|
|`fee_structures`|Defines fee types, amounts, and applicable conditions|
|`payments`|Records payment transactions by students / parents|
|`discounts`|Discount or waiver definitions applicable to fees|
|`invoices`|Billing records issued to students or parents|
|`student_fee_mappings`|Maps students to applicable fees, discounts, and payment plans|

---

## 📄 Schema Definitions (PostgreSQL + SQL DDL)

---

### 💰 `fee_structures`

```sql
CREATE TABLE finance.fee_structures (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    name        VARCHAR(100) NOT NULL,          -- e.g. “Tuition Fee”
    description TEXT,
    amount      NUMERIC(12,2) NOT NULL CHECK (amount >= 0),

    applicable_class_id        UUID REFERENCES academics.classes(id),
    applicable_section_id      UUID REFERENCES academics.sections(id),
    applicable_academic_year   UUID REFERENCES configuration.academic_years(id),

    is_recurring      BOOLEAN DEFAULT TRUE,     -- monthly, quarterly …
    recurrence_period VARCHAR(20),              -- 'monthly' | 'quarterly' | 'yearly'

    metadata JSONB DEFAULT '{}',

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id),

    CONSTRAINT unique_fee_structure_name
      UNIQUE (name, applicable_class_id, applicable_section_id, applicable_academic_year)
);

CREATE INDEX idx_fee_structures_class_section_year ON finance.fee_structures(applicable_class_id, applicable_section_id, applicable_academic_year);
CREATE INDEX idx_fee_structures_created_by         ON finance.fee_structures(created_by);
CREATE INDEX idx_fee_structures_updated_by         ON finance.fee_structures(updated_by);
CREATE INDEX idx_fee_structures_deleted_by         ON finance.fee_structures(deleted_by);
```

---

### 💳 `payments`

```sql
-- ENUM now guarantees consistent status values across API, DB & analytics
CREATE TYPE finance.payment_status AS ENUM ('pending','completed','failed','refunded');

CREATE TABLE finance.payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    student_id       UUID NOT NULL REFERENCES student.students(id)      ON DELETE CASCADE,
    fee_structure_id UUID NOT NULL REFERENCES finance.fee_structures(id)ON DELETE RESTRICT,
    invoice_id       UUID           REFERENCES finance.invoices(id)     ON DELETE SET NULL,

    payment_method   VARCHAR(50) NOT NULL,          -- 'credit_card' | 'cash' | …
    amount           NUMERIC(12,2) NOT NULL CHECK (amount >= 0),
    payment_date     TIMESTAMPTZ  NOT NULL DEFAULT now(),
    transaction_reference VARCHAR(100) UNIQUE,

    payment_status   finance.payment_status NOT NULL DEFAULT 'pending',
    remarks          TEXT,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

CREATE INDEX idx_payments_student        ON finance.payments(student_id);
CREATE INDEX idx_payments_fee_structure  ON finance.payments(fee_structure_id);
CREATE INDEX idx_payments_status         ON finance.payments(payment_status);
CREATE INDEX idx_payments_created_by     ON finance.payments(created_by);
CREATE INDEX idx_payments_updated_by     ON finance.payments(updated_by);
CREATE INDEX idx_payments_deleted_by     ON finance.payments(deleted_by);
```

---

### 🎟️ `discounts`

```sql
CREATE TABLE finance.discounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    code        VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    amount      NUMERIC(12,2) CHECK (amount >= 0),
    percentage  NUMERIC(5,2)  CHECK (percentage BETWEEN 0 AND 100),

    applicable_class_id      UUID REFERENCES academics.classes(id),
    applicable_section_id    UUID REFERENCES academics.sections(id),
    applicable_academic_year UUID REFERENCES configuration.academic_years(id),

    active      BOOLEAN DEFAULT TRUE,
    valid_from  DATE,
    valid_until DATE,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

CREATE INDEX idx_discounts_code               ON finance.discounts(code);
CREATE INDEX idx_discounts_active             ON finance.discounts(active);
CREATE INDEX idx_discounts_class_section_year ON finance.discounts(applicable_class_id, applicable_section_id, applicable_academic_year);
CREATE INDEX idx_discounts_created_by         ON finance.discounts(created_by);
CREATE INDEX idx_discounts_updated_by         ON finance.discounts(updated_by);
CREATE INDEX idx_discounts_deleted_by         ON finance.discounts(deleted_by);
```

---

### 🧾 `invoices`

```sql
CREATE TYPE finance.invoice_status AS ENUM ('draft','sent','paid','overdue','cancelled');

CREATE TABLE finance.invoices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    student_id     UUID NOT NULL REFERENCES student.students(id) ON DELETE CASCADE,
    invoice_number VARCHAR(100) UNIQUE NOT NULL,

    issue_date    DATE NOT NULL DEFAULT CURRENT_DATE,
    due_date      DATE,
    total_amount  NUMERIC(12,2) NOT NULL CHECK (total_amount >= 0),
    status        finance.invoice_status NOT NULL DEFAULT 'draft',

    metadata JSONB DEFAULT '{}',

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id)
);

CREATE INDEX idx_invoices_student     ON finance.invoices(student_id);
CREATE INDEX idx_invoices_status      ON finance.invoices(status);
CREATE INDEX idx_invoices_created_by  ON finance.invoices(created_by);
CREATE INDEX idx_invoices_updated_by  ON finance.invoices(updated_by);
CREATE INDEX idx_invoices_deleted_by  ON finance.invoices(deleted_by);
```

---

### 🔄 `student_fee_mappings`

```sql
CREATE TABLE finance.student_fee_mappings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    student_id       UUID NOT NULL REFERENCES student.students(id)        ON DELETE CASCADE,
    fee_structure_id UUID NOT NULL REFERENCES finance.fee_structures(id)  ON DELETE RESTRICT,
    discount_id      UUID           REFERENCES finance.discounts(id)      ON DELETE SET NULL,

    start_date DATE NOT NULL,
    end_date   DATE,
    is_active  BOOLEAN DEFAULT TRUE,

    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,

    created_by UUID REFERENCES auth.users(id),
    updated_by UUID REFERENCES auth.users(id),
    deleted_by UUID REFERENCES auth.users(id),

    CONSTRAINT unique_fee_mapping
      UNIQUE (student_id, fee_structure_id, start_date)
);

CREATE INDEX idx_student_fee_mappings_student       ON finance.student_fee_mappings(student_id);
CREATE INDEX idx_student_fee_mappings_fee_structure ON finance.student_fee_mappings(fee_structure_id);
CREATE INDEX idx_student_fee_mappings_discount      ON finance.student_fee_mappings(discount_id);
CREATE INDEX idx_student_fee_mappings_is_active     ON finance.student_fee_mappings(is_active);
CREATE INDEX idx_student_fee_mappings_created_by    ON finance.student_fee_mappings(created_by);
CREATE INDEX idx_student_fee_mappings_updated_by    ON finance.student_fee_mappings(updated_by);
CREATE INDEX idx_student_fee_mappings_deleted_by    ON finance.student_fee_mappings(deleted_by);
```

---

## 📌 Design Notes & Best Practices

- **ENUM-based `payment_status`** (`pending`, `completed`, `failed`, `refunded`) guarantees typo-free statuses across DB, API and UI.
    
    - Clients should treat the enum list as authoritative for filters & charts.
        
- `fee_structures`, `discounts`, `invoices` and mappings remain fully normalized, promoting flexible academic-year and class-specific billing.
    
- Every table carries **audit columns** (`created_at/by`, `updated_at/by`, `deleted_at/by`) plus **soft-delete** (`deleted_at`) to allow reversible operations and historical reporting.
    
- **Indexes** focus on the hottest query paths — status, student IDs, foreign keys — ensuring finance dashboards and year-end reports stay snappy.
    

---