
### üéØ Overview: Security Goals & Enforcement

|Goal|Implementation|
|---|---|
|**Defense in Depth**|Security at every layer ‚Äî validation, auth, transport, DB, UI, access control|
|**Role-based Access Control**|Role and permission matrix enforced at route, service, and query levels|
|**Zero Trust**|Every request authenticated and authorized; no implicit trust across modules|
|**Secure by Default**|Strong password policy, TLS enforcement, no dangerous defaults|
|**Minimize Attack Surface**|Only expose APIs via versioned gateway, avoid over-broad endpoints|
|**Security Observability**|Audit logs, anomaly detection (optional), rate-limiting, trace IDs|

---

### üßº 1. Input Validation & Sanitization

|Layer|Strategy|
|---|---|
|**Backend**|Zod schemas for all DTOs ‚Äî enforced at controller layer|
|**Frontend**|Co-located Zod validation with forms (React Hook Form + Zod)|
|**Escape Injection**|No manual string interpolation; Prisma uses parameterized queries|
|**Upload Sanitization**|MIME-type checks, filename stripping, size limits via Multer|
|**File/HTML Sanitization**|Sanitize all user-generated content if exposed in rich text (e.g., forums)|

---

### üîê 2. Authentication & Token Security

|Area|Strategy|
|---|---|
|**Auth type**|JWT (access token short-lived, refresh token rotated)|
|**Access token storage**|HttpOnly cookie (XSS-safe, optionally SameSite=Strict)|
|**Refresh flow**|Secure refresh endpoint with token binding or IP/user-agent checks|
|**Multi-session support**|Optional ‚Äî device/session tracking via `user_sessions` table|
|**Token invalidation**|Blacklist on password reset, role change, or logout|
|**2FA (Optional)**|Pluggable via TOTP or SMS/email OTP via notification module|
|**Transport Security**|Enforce HTTPS on all environments; redirect HTTP to HTTPS|

---

### üßÆ 3. Role-Based Access Enforcement (RBAC)

|Concern|Strategy|
|---|---|
|**Route guards**|NestJS `@RolesGuard()` with custom decorators (`@Roles('teacher')`)|
|**Fine-grained rules**|Service layer checks for object ownership, class-assignment, module-level access|
|**Field-level access**|Prisma middleware filters fields returned based on role context|
|**Client enforcement**|React hook (`useAuth`, `useRoleAccess`) gates UI/UX routes and layouts|
|**Audit-sensitive actions**|Only allowed for Admins and SuperAdmin (if applicable)|
|**UI boundaries**|Role-scoped layouts + client redirects using Next.js middleware|

---

### üîë 4. Password Management

|Feature|Implementation|
|---|---|
|**Hashing**|Argon2id via `argon2` package (or `bcrypt` as fallback)|
|**Salt**|Unique per user; included automatically in Argon2|
|**Reset flow**|Tokenized link with short expiry (15 mins), one-time use, logged in audit trail|
|**Strength policy**|Zxcvbn-based strength check client-side; enforced backend-side via Zod|
|**Reuse prevention**|Optional ‚Äî maintain password history hash list (configurable retention)|

---

### üîÑ 5. Session Management

|Area|Strategy|
|---|---|
|**Session tracking**|Optional `user_sessions` table ‚Äî stores IP, device, login time|
|**Logout**|Hard deletes current session; rotates refresh token|
|**Force logout**|Admin can invalidate all user sessions (e.g., on compromise)|
|**Idle timeout**|Token expires in ~15 min (configurable); refresh available unless blacklisted|
|**Concurrent session limit**|Can limit sessions per user (e.g., max 3 active devices)|

---

### üöß 6. Rate Limiting & Abuse Protection

|Concern|Strategy|
|---|---|
|**Global limits**|Redis-backed limiter via `@nestjs/throttler`|
|**Per-IP rate limits**|Login, reset, forum posting, and file upload endpoints|
|**CAPTCHA on abuse**|hCaptcha/Google CAPTCHA on sensitive forms after repeated failure attempts|
|**Lockout policy**|Optional ‚Äî lock account or rate slow login on repeated password failures|
|**Replay protection**|JWT jti (token ID) checked against last issued token|

---

### üìù 7. Audit Logging & Monitoring

|Activity|Strategy|
|---|---|
|**Login attempts**|Logged with IP, user ID, result, user-agent|
|**Permission changes**|Tracked with who-initiated, who-targeted, when, what changed|
|**Sensitive actions**|Edits/deletes in Finance, Attendance, Academic ‚Äî all logged|
|**File uploads/deletions**|File ID, filename, user, time logged|
|**Admin actions**|Separate audit trail (`audit_logs` table or event bus stream)|
|**Error visibility**|Errors tracked via Pino, with request context, user ID, trace ID (sent to Sentry optionally)|

---

### üõ°Ô∏è 8. OWASP & Compliance

|Risk Area|Coverage|
|---|---|
|**SQL Injection**|Prevented via Prisma ORM parameterization|
|**XSS**|All data rendered in frontend sanitized or escaped; no untrusted innerHTML|
|**CSRF**|Avoided via HttpOnly cookies; additional CSRF token optional for forms|
|**IDOR**|Access guards ensure only owners or admins can access resources|
|**Security Headers**|`Helmet` middleware used with CSP, X-Frame, Referrer-Policy, HSTS|
|**Sensitive Data Exposure**|No PII returned unless authorized; encrypted fields at DB level (e.g., parent contact, grades)|
|**Logging hygiene**|No passwords, tokens, or sensitive env leaked into logs|
|**Transport layer security**|HTTPS-only; HSTS enabled|

---

## ‚úÖ Summary Table

|Security Area|Primary Tools/Practices|
|---|---|
|Input Validation|Zod + React Hook Form + Prisma DTO enforcement|
|Authentication|JWT w/ refresh, HttpOnly cookie, TOTP optional|
|Authorization|NestJS Guards, role-based decorators, service-level checks|
|Rate Limiting|Redis-backed `@nestjs/throttler`, CAPTCHA on spammy endpoints|
|Password Policy|Argon2id, strength validation, reset tokenization|
|Session Control|Refresh token rotation, session logs, force logout option|
|Audit Logging|Pino logs + optional Kafka event streams|
|OWASP Compliance|Defense against XSS, CSRF, SQLi, IDOR, PII exposure|

---
